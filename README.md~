# BGP学习与实验笔记

***

实验时的eNSP拓扑在ensptopo文件夹中。

***

1.

先配在做好两个AS内部的OSPF配置：

使192.168.1.0/24\~192.168.3.0/24及1.1.1.1, 2,2,2,2, 3.3.3.3可以相互ping通；

使192.168.5.0/24\~192.168.7.0/24及4.4.4.4, 5.5.5.5, 6.6.6.6可以相互ping通。

<br/>

2.

这时两个AS是不通的。

在这时也不应该通，这里先试一下，试完之后再调回去。

让AR3和AR4都把192.168.4.0/24网段发布到各自AS的area 0，这时两个AS可以ping通了。

以我目前的理解，我觉得这算是把两个AS合并成了一个AS，在这个合并后的AS中，AR2到AR5之间都是area 0，pc1到pc2之间（若pc的路由是通过network+silent方式加入OSPF的，则pc所在网段属于OSPF的域；若pc的路由是通过import的方式加入OSPF的，则pc所在的网段不属于OSPF的域）都是area 100，area 100包含着area 0。

于是将AR3的GE0/0/1和AR4的GE0/0/0设为silent-interface，这样这两个端口就只接收不发送OSPF报文(现在是2017年9月19日，再看，感觉，这个说法不理解，现在我的想法是，并不是说，这两个端口只接收不发送OSPF报文，而是OSPF的报文不从这两个口发送出去，但是这两个口所在网段的路由信息会从这台路由器的别的口发送出去)（2017年9月16日再看，感觉，因为在OSPF里（RIP同）宣告了这个网段，所以这个网段的信息会通过OSPF发出去，但是某个口设了silent，则OSPF的信息不从这个口发出去），两个AS都不能接收到对方的OSPF信息，而只能接收到192.168.4.0/24网段的OSPF信息，能和192.168.4.0/24网段通信，不能和另一个AS通信。

在这时也不应该通，这里先试一下，试完之后再调回去。

<br/>


3.

在每个路由器上开启BGP。

建立IBGP邻居：

AR1,AR2,AR3属于bgp 13；AR4,AR5,AR6属于bgp 24。

AR1,AR2,AR3两两建立BGP邻居，AR4,AR5,AR6两两建立BGP邻居。（注意：是两两！详见下文）IBGP可以直接用环回口建立邻居。

详细地：

AR1与AR2建立BGP邻居，AR1与AR3建立BGP邻居，AR2与AR3建立BGP邻居。

AR4与AR5建立BGP邻居，AR4与AR6建立BGP邻居，AR5与AR6建立BGP邻居。

建立EBGP邻居：

AR3与AR4建立BGP邻居。EBGP我没有用环回口建立邻居，若用环回口的话，需要修改EBGP最大跳数。

<br/>

4.

在AR3和AR4的BGP上引入OSPF路由。

<br/>


5.

这时由于所有路由器都接收到了来自BGP的另一个AS的路由，但是由于BGP下一跳的特性，

AS 13中路由器通向AS 24的路由的下一跳都是192.168.4.3；

AS 24中路由器通向AS 13的路由的下一跳都是192.168.4.2。

但是没有做第2步的操作的话，两个AS内的路由器没有通向这下一跳的路由，所以并不能ping通另一个AS。这

这下一跳是不可达的，我试了两个解决方法：

（1）第2步的方法，在AR3和AR4上把192.168.4.0/24网段宣告进OSPF，并将AR3的GE0/0/1和AR4的GE0/0/0设为silent，即network+silent方式；

（2）在AR3和AR4上，将直连路由（direct）引入OSPF（即import方式）。

这两种方法都可以让一个AS中的路由器获得通往处于另一个AS中的路由器的下一跳的路由。（即AS 13中的路由器获得192.168.4.3的路由，AS 24中的路由器获得192.168.4.2的路由）

<br/>

6.

但是一个AS里感觉一般不是所有的路由器都开启BGP，应该是只有处于AS边界的（与其它AS中的路由器直连的）路由器才会开启BGP。

但是没有开启BGP的路由器应该怎么获得通向其它AS中的路由器路由呢？

我想到的是通过默认路由，在没有开启BGP的路由器上设置指向开启BGP的路由器的默认路由。并进行了实验。

把AR1和AR6相关的BGP配置都取消掉。

这样就有了这样一个情境：

AR2,AR3,AR4,AR5开启了BGP，AR1,AR6没有开启BGP。

这时AR1和AR6是不能ping通另一个AS中的路由器的。

然后在AR1加一条指向AR3的默认路由，在AR6加一条指向AR4的默认路由，AR1和AR6便可以ping通另一个AS中的路由器了。

<br/>

在做完第7步之后，我有了一个错误的想法，觉得既然AR3本身就有192.168.4.3的路由（直连），而AR1的默认网关设置的是AR3，所以AR1把发往PC2的包发给AR3，AR3就可以把包发到PC2，这样就不需要在AR3引入或宣告192.168.4.0/24网段的路由。

但这种想法是错误的，（静态路由的确可以指向任意可达的地址）虽然AR1把发往PC2的包发到下一跳3.3.3.3，但是包的目的地址仍然是PC2的地址，包要传输到AR3必须经过AR2，这AR2接收到包之后发现下一跳是192.168.4.3，但是AR2没有192.168.4.3的路由，于是就直接把包丢掉了

（这里我也不能百分之百地确定丢包的具原因，我写的这个原因和实际原因可能会有一些偏差，如果我写的这个原因是对的，那么在设定静态路由的时候还是要尽量设定直连的地址，并在沿途路由器上一一设置，否则有可能在中间被截掉，传到别的地方去或丢弃）

，包也就传不到AR3，也就传不到PC2。

<br/>

7.

我又试了一下，不在AS 24中使用OSPF，而使用RIP协议。

把AS 24中的OSPF相关的配置都取消掉。

在AS 24中开启RIP，并宣告各个网段。注：RIPv2宣告网络必须使用网络号，且不能带掩码，故A类、B类、C类（、D类、E类？？？）网络要注意：

如环回口3.3.3.3是A类地址，必须宣告3.0.0.0；

192.168.1.2是C类地址，必须宣告192.168.1.0;

172.16.1.2是B类地址，必须宣告172.16.0.0。

配置发RIP之后，

RIP同OSPF在这点类似，也可以通过import或network+silent这两种方式把192.168.4.0/24网段引入或者宣告进RIP。让AS 24中的路由器有了通向192.168.4.2这个下一跳的路由。




